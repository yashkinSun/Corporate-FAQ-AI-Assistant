# Полная и актуальная инструкция по развертыванию Telegram-бота Botvopros

**Версия документа:** 2.0 (основана на анализе исходного кода от 10.12.2025)

## Введение

Эта инструкция представляет собой **полное и технически выверенное руководство** по развертыванию Telegram-бота **Botvopros** и его веб-интерфейса. Она создана после детального анализа исходного кода и заменяет собой предыдущие версии документации, которые содержали ряд неточностей.

### Ключевые выводы из анализа кода:

1.  **База данных**: Для продуктивной работы **обязательно используется PostgreSQL**. Поддержка SQLite (`bot_database.sqlite`) предназначена только для локальной разработки и не подходит для развертывания в Docker.
2.  **Инициализация БД**: База данных и все необходимые таблицы **создаются автоматически** при первом запуске контейнеров. Никаких ручных миграций или инициализаций не требуется.
3.  **Режим работы Telegram-бота**: Бот работает в режиме **Polling** (постоянные опросы сервера Telegram), а не через Webhook. Это упрощает настройку, так как не требует проброса дополнительных портов для веб-хуков.
4.  **Конфигурация**: Все параметры приложения гибко настраиваются через переменные окружения в `.env` файле. Список переменных значительно шире, чем в первоначальной документации.

Данное руководство учитывает вашу существующую инфраструктуру с **Traefik** и другими Docker-контейнерами, обеспечивая бесшовную и безопасную интеграцию.

---

## Шаг 1: Подготовка конфигурационного файла (`.env`)

Это самый важный шаг, на котором задаются все параметры работы бота.

1.  **Создайте файл `.env.botvopros`**:

    В директории `/home/ubuntu/` был создан актуальный шаблон `env.botvopros.actual.example`. Скопируйте его, чтобы создать основной конфигурационный файл:

    ```bash
    cp /home/ubuntu/env.botvopros.actual.example /home/ubuntu/.env.botvopros
    ```

2.  **Отредактируйте файл `/home/ubuntu/.env.botvopros`**:

    Откройте файл в текстовом редакторе и **внимательно** заполните обязательные поля. Ниже приведено объяснение ключевых секций.

    #### Секция: CORE SETTINGS (Обязательно к заполнению)

    ```env
# --- Telegram Bot ---
TELEGRAM_BOT_TOKEN=your_bot_token

# --- OpenAI API ---
OPENAI_API_KEY=your_api_key

# --- Security ---
# Сгенерируйте с помощью команды: openssl rand -hex 32
JWT_SECRET_KEY=your_jwt_key

# --- Administrators ---
# Telegram ID администраторов через запятую. Получите ID через @userinfobot
ADMIN_IDS=111222333
# ID основного оператора для эскалации диалогов
OPERATOR_ID=11122233
# --- DB SETTINGS ---
PG_USER=botvopros_user
# ВАЖНО: Замените этот пароль на надежный!
PG_PASSWORD=YOUR_PASSWORD
PG_DB=botvopros_db
# Хост должен соответствовать имени сервиса в docker-compose
PG_HOST=botvopros-postgres
PG_PORT=5432
# -- REDIS SETTINGS ---
REDIS_HOST=botvopros-redis
REDIS_PORT=6379
# -- Остальные параметры имеют разумные значения по умолчанию в конфиге и могут быть добавлены в .env при необходимости кастомных значений -- 

    ```
    #### Проверяем наличие папок и даем доступы 
    ```
    mkdir -p /home/ubuntu/apps/chatbot/Botvoprosrelease/data
    mkdir -p /home/ubuntu/apps/chatbot/Botvoprosrelease/logs
    chmod 755 /home/ubuntu/apps/chatbot/Botvoprosrelease/data
    chmod 755 /home/ubuntu/apps/chatbot/Botvoprosrelease/logs
    ```


## Шаг 2: Проверка Docker Compose файла

Ранее был подготовлен адаптированный `docker-compose-botvopros.yml`, который находится в `/home/ubuntu/`. Он уже настроен для работы с вашей сетью `n8n_default` и резолвером `mydns` в Traefik. Убедитесь, что он на месте. Никаких изменений в него вносить не нужно.

---

## Шаг 3: Настройка DNS

Для корректной работы веб-интерфейса через Traefik необходимо настроить DNS.

В панели управления **Cloudflare** для вашего домена `palmbit-servers.org` создайте **A-запись**:

-   **Тип**: `A`
-   **Имя**: `assistant`
-   **IPv4-адрес**: IP-адрес вашего сервера `vps-75ec6eb5`
-   **Proxy status**: `DNS only` (серая тучка). Traefik сам будет управлять SSL-сертификатом.

---

## Шаг 4: Развертывание

Теперь, когда конфигурация готова, можно запустить контейнеры.

1.  **Выполните команду запуска**:

    Выполните следующую команду из любой директории (все пути в команде абсолютные, поэтому ваше текущее местоположение не имеет значения):

    ```bash
    docker-compose -f /home/ubuntu/docker-compose-botvopros.yml --env-file /home/ubuntu/.env.botvopros up -d
    ```

    **Пояснение команды:**
    -   `-f /home/ubuntu/docker-compose-botvopros.yml`: Указывает путь к адаптированному файлу конфигурации Docker Compose.
    -   `--env-file /home/ubuntu/.env.botvopros`: Указывает путь к файлу с вашими секретными ключами и настройками.
    -   `up -d`: Собирает образы (так как в `docker-compose` указан `build`) и запускает контейнеры в фоновом режиме.

2.  **Процесс первого запуска**:
    -   Docker начнет сборку образа из `Dockerfile` в директории `/home/ubuntu/apps/chatbot/Botvoprosrelease`. Это может занять несколько минут.
    -   После сборки будут запущены все сервисы: `botvopros-postgres`, `botvopros-redis`, `botvopros-telegram`, `botvopros-web`.
    -   При первом запуске `botvopros-telegram` и `botvopros-web` автоматически вызовут функцию `init_db()`, которая создаст все необходимые таблицы в базе данных PostgreSQL.

---

## Шаг 5: Проверка работоспособности

1.  **Проверьте статус контейнеров**:

    ```bash
    docker ps | grep botvopros
    ```

    Вы должны увидеть четыре новых контейнера: `botvopros-web`, `botvopros-telegram`, `botvopros-postgres`, `botvopros-redis`. Все они должны быть в статусе `Up`.

2.  **Проверьте веб-интерфейс**:
    Откройте в браузере `https://assistant.palmbit-servers.org`. Вы должны увидеть страницу входа в веб-интерфейс бота. Traefik автоматически обработает запрос и выдаст SSL-сертификат.

3.  **Проверьте Telegram-бота**:
    Отправьте команду `/start` вашему боту в Telegram. Он должен ответить приветственным сообщением.

4.  **Анализ логов (в случае проблем)**:
    Если что-то пошло не так, логи — ваш лучший друг.

    ```bash
    # Логи веб-интерфейса
    docker logs -f botvopros-web

    # Логи Telegram-бота
    docker logs -f botvopros-telegram
    
    # Логи базы данных (полезно для отладки проблем с подключением)
    docker logs -f botvopros-postgres
    ```

---

## Управление сервисами

Для управления используйте ту же команду, меняя только последнюю часть.

-   **Остановка сервисов**:
    ```bash
    docker-compose -f /home/ubuntu/docker-compose-botvopros.yml down
    ```

-   **Перезапуск сервисов**:
    ```bash
    docker-compose -f /home/ubuntu/docker-compose-botvopros.yml restart
    ```

-   **Обновление после изменений в коде**:
    Если вы внесли изменения в код бота в папке `/home/ubuntu/apps/chatbot/Botvoprosrelease`, необходимо пересобрать образы и перезапустить контейнеры:
    ```bash
    docker-compose -f /home/ubuntu/docker-compose-botvopros.yml up -d --build
    ```

Развертывание завершено. Ваш бот полностью интегрирован в существующую инфраструктуру и готов к работе. 
готов к работе.
